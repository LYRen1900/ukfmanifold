% Emanuele Ruffaldi 2017 @ SSSA
function [xp,Pp,Xsp,Xs_chi] = manistatestep(mx,x0,P0,f_fx,Q,wsigmax)

    if nargin < 6
        wsigmax = mx.wsigma;
    end
    if nargin < 5
        Q = [];
    end
    
    % process: if not identity
    if isempty(f_fx) == 0
        [Xs,Xs_chi] = manisigmas(mx,x0,P0,wsigmax);   % [S,Gx]
        assert(size(Xs,2) == mx.group);
        
        cXs = maniunpack(mx,Xs);     % [S,Cx]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
        assert(size(cXs,2) == mx.count);
        assert(size(cXs,1) == size(cXs,1));
        
        cpXs = cell(size(cXs)); % [S,Cx]
        for I=1:size(cXs,1)
            [cpXs{I,:}] = f_fx(cXs{I,:}); % deal expansion
        end    
        Xsp = manipack(mx,cpXs);
        [xp,Pp] = maniunsigma(mx,Xsp,wsigmax);
        if ~isempty(Q)
            Pp = Pp + Q; % noise additive
        end
    else
        xp = x0; 
        if ~isempty(Q)
            Pp = P0 + Q; % noise additive
        end
        if nargout >= 3
            [Xs,Xs_chi] = manisigmas(mx,xp,PP,wsigmax);   % [S,Gx]
        end
    end    